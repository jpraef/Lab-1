---
title: "Lab7"
output: html_document
---

Joseph Crockett  
ES 207: Environmental Data Analysis  
April 1st, 2016  
Homework Assignment 7: Time & Space  


```{r global_options, include = FALSE}
knitr::opts_chunk$set(fig.width = 12, fig.height = 8, warning = FALSE, message = FALSE)

#check for needed packages, install if needed, then adds to environment
ndpkg <- function(p){
 if(!is.element(p,installed.packages()[,1]))
   {install.packages(p, dep = T)}
  require(p,character.only = T)
}
sapply(c("foreign", "ggplot2", "reshape", "raster", "rgdal","dplyr","gridExtra"), ndpkg)

#EDA function
CV1 <- function(x){
  print((sd(x)/mean(x))*100)
}

```


Objective Statement:   
Purposeful flooding of the Cosumnes River floodplain could stimulate localized recharge of the groundwater aquifer and spur fish populations.  However, the expense may not be worth the investment if flooding does not occure often enough. We will examine the discharge levels at the USGS gaging station at Michigan Bar to determine the percentage of years that discharges >= 800 cubic feet per second occur 100 days or more.  Groundwater aquifers will benefit if floods occur in 50% of years. 
Methods:  
Our first goal is to gather data from the California Data Exchange Center with a unique function that will extract from a query URL.  We will next remove leap days and examine monthly autocorrelation,  including total, mean, and maximum discharge by month.  The number of flood events (days during which average discharge equals or exceeds 800 cfs) per water year will finally be calculated

Data:  
We will retrive historical river conditions at Michigan Bar from the California Data Exchange Center for the period 1908 to 2015
```{r Data}

Code: 
```{r Step 1}
# The provided function getCDEC encounters problems when the date format "m/d/Y" is used: csv files will not be written with the / symbol.  The fixed function, also provided, corrects this with the addition of "as.character(strptime(...))" on lines 53 and 54.  An alternative to this would be to use the function "format" to rearrange the start and end times to "m-d-Y" regardless of the input format.

#Extracting data from URL
get.dailyUSGS <- function(site, sensor, start, end){
  #site = site number (11335000 for Michigan Bar)
  #sensor = sensor parameter (00060 for discharge)
  #start and end values can be in mm-dd-yyyy or mm/dd/yyyy forms
  start <- format(as.Date(start, "%m/%d/%Y"),"%Y-%m-%d") #format date in form m - d - y for URL
  print(start)
  end <- format(as.Date(end,"%m/%d/%Y"), "%Y-%m-%d")
  print(end)
  print(site)
  print(sensor)
  data <- read.table(paste0("http://waterdata.usgs.gov/nwis/dv?cb_",sensor,"=on&format=rdb&site_no=",site,"&referred_mo dule=sw&period=&begin_date=",start,"&end_date=",end), header = T) #header = T removes one of the two unnecessary rows
  
  assign("daily_sf", data, envir = .GlobalEnv) #assign to the global environment
  
}

get.dailyUSGS("11335000", "00060", "10/01/1907", "09/30/2015")

water_dat <- daily_sf
water_dat <- droplevels(water_dat[-1,]) #remove the first row
colnames(water_dat) [4:5] <- c("discharge_cfs","dat_qvalue") #rename the last two columns

water_dat[,"datetime"] <- as.POSIXct(water_dat[,"datetime"], tz = "PST") #convert datetime into POSIXct format, with timezone PST.

water_dat[,"discharge_cfs"] <- as.double(as.character(water_dat[,"discharge_cfs"])) #convert discharge cfs to numeric(double format)

water_dat[,"discharge_afd"] <- 



Results:  
Discussion:  
Limitation:  