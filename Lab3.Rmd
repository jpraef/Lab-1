---
title: "Lab_3"
author: "Joseph Crockett"
date: "February 21, 2016"
output: html_document
---
```{r global_options include = FALSE}
knitr::opts_chunk$set(fig.width = 12, fig.height = 8, warning = FALSE, message = FALSE)

#check for needed packages, install if needed, require if not
ndpkg <- function(p){
  ifelse(is.element(p,installed.packages()[,1]),require(p,character.only = T), install.packages(p, dep = T))
}
sapply(c("ggplot2", "reshape", "gridExtra", "car", "dplyr"), ndpkg)

#load subset data into the global environment as characters
ripdata_s <- read.csv("~/Desktop/Documents/Writings/Spring 2016/ES 207/Labs/Lab1/riparian_survey_subset.csv", row.names=1, stringsAsFactors=FALSE)
```

Joseph Crockett
February 21, 2016
ES 207: Environmental Data Analysis

Homework 3: Pre-regression

Objective Statement:  
Aboveground carbon stocks, as a function of biomass, cannot be directly measured without destroying the sample.  An alternative is to estimate volume using measurments of tree height and diameter at breast height (DBH). Our objective is to 1) develop a linear model relating height to DBH and 2) determine whether project site or genus affects the model.  

Methods:  
Following preliminary data analysis, we developed a global linear model using the R function "lm(ripdata[,htcm] ~ ripdata[,dbh]) relating height to DBH.  Outliers were then found and removed in order to improve model fit. To further improve fit, we natural log transformed sample values for a second global model. Tertiary linear models for each project site and genus were also created.   
Data:  
Measurements of five most frequent tree genera at four project sites in Northern California.   

Code:  
```{r Step 1}
#Examining subset of riparian data
str(ripdata_s)
head(ripdata_s)
tail(ripdata_s)
unique(ripdata_s[,"Genus"])
unique(ripdata_s[,"ProjCode"])

#plotting height by project site and genus
g <- ggplot(data = ripdata_s) 

#Histograms and densities of ht and DBH
p1 <- g + geom_boxplot(aes(x = ProjCode, y = Woody_Height_m, fill = Genus))
p2 <- g + geom_histogram(aes(x = Woody_Height_m))
p3 <- g + geom_density(aes(x = Woody_Height_m))

```

```{r Step 2}
#Change height units to DBH units (m to cm)
ripdata_s[,"Woody_Height_cm"] <- ripdata_s[,"Woody_Height_m"] *100

g2 <- ggplot(data = ripdata_s) 
p4 <- g2 + geom_histogram(aes(x = Woody_DBH_cm))
p5 <-g2 + geom_density(aes(x = Woody_DBH_cm))
#Force a zero intercept
incpt <- 0.0
ripdata_s_lm <- lm(I(Woody_Height_cm - incpt) ~ 0 + Woody_DBH_cm, ripdata_s)

#Plot line & observations, sep by genus
p6 <- g2 + geom_point(aes(x = Woody_DBH_cm, y = Woody_Height_cm, color = Genus)) + geom_abline(intercept = 0, slope = coef(ripdata_s_lm))

```
```{r Step 3}
#Find outliers
rip_ol <- outlierTest(ripdata_s_lm)
rip_ol_id <- as.numeric(names(rip_ol$rstudent))

p7 <- g2 + geom_point(aes(x = Woody_DBH_cm, y = Woody_Height_cm, color = Genus)) + geom_abline(intercept = 0, slope = coef(ripdata_s_lm)) + geom_point(data = ripdata_s[rip_ol_id,],aes(x = Woody_DBH_cm, y = Woody_Height_cm), color = "black", shape = 17)


ripdata_ss <- ripdata_s[!(rownames(ripdata_s) %in% rip_ol_id) ,]

ripdata_ss_lm <- lm(I(Woody_Height_cm - incpt) ~ 0 + Woody_DBH_cm, ripdata_ss)

p8 <- ggplot(data = ripdata_ss) + geom_point(aes(x = Woody_DBH_cm, y = Woody_Height_cm, color = Genus))+ geom_abline(intercept = 0, slope = coef(ripdata_ss_lm))

```

```{r Step 4}
ripdata_s[,"WH_cm_log"] <- log(ripdata_s[,"Woody_Height_cm"])
ripdata_s[,"DBH_cm_log"] <- log(ripdata_s[,"Woody_DBH_cm"])


g3 <- ggplot(data = ripdata_s)
p9 <- g3 + geom_histogram(aes(x = WH_cm_log))
p10 <- g3 + geom_density(aes(x = WH_cm_log))
p11 <- g3 + geom_histogram(aes(x = DBH_cm_log))
p12 <- g3 + geom_density(aes(x = DBH_cm_log))

ripdata_s_lm_log <- lm(I(WH_cm_log - incpt) ~ 0 + DBH_cm_log, ripdata_s)


p13 <- g3 + geom_point(aes(x = DBH_cm_log, y = WH_cm_log, color = Genus)) + geom_abline(intercept = 0, slope = coef(ripdata_ss_lm_log)) + scale_x_continuous(limits = c(0, 5)) + scale_y_continuous(limits = c(0, 10)) 

#Making labels for the graph
lm_prj_gen <- function(xx){
  lmod <- lm(I(Woody_Height_cm - incpt) ~ 0 + Woody_DBH_cm,  data = xx)
 r2 <- summary(lmod)$r.squared 
 data.frame(r2 = r2, stringsAsFactors = F)
}

lm_labs <- ddply(ripdata_s, .(Genus,ProjCode), lm_prj_gen)

#graphing genus vs projcode, with lm line and r2 labeled
p14 <- ggplot(data = ripdata_s, aes(x = Woody_DBH_cm, y = Woody_Height_cm)) + geom_point() + stat_smooth(formula = I(y - incpt) ~ (0 + x), method = "lm", se = FALSE)  + facet_grid(ProjCode ~ Genus) + geom_text(data = lm_labs, aes(x = 50, y = 7000, label = paste("r2 = ", round(r2, digits = 2), sep = " ")))
 
```
```{r Step 5}

```

Results:  
Discussion:  
Limitations:  

